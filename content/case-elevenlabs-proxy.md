# Кейс: Голосовой AI-помощник перестал работать. Как мы починили за 70 минут

## TL;DR

Воскресенье. Сообщение от клиента: "Виджет не работает". С VPN — работает, без — нет. Причина — санкции США против ElevenLabs. Решение — WebSocket прокси через US-сервер. Время на фикс — 70 минут. Доп. расходы — $7/мес.

---

## Предыстория

Клиент из **сферы недвижимости** (название под NDA). На сайте установлен голосовой AI-помощник — виджет, который консультирует посетителей и собирает заявки. Технология — ElevenLabs Conversational AI.

Работало стабильно несколько месяцев. До вчерашнего дня.

---

## Проблема

> "Виджет перестал работать. С VPN работает, без VPN — нет"

Классика: работало → сломалось → ничего не меняли.

---

## Для бизнеса: почему это критично

**Что теряет бизнес, когда виджет не работает:**

- Упущенные заявки — посетители уходят без консультации
- Репутация — "у них там что-то сломано"
- Время менеджеров — ручная обработка вместо автоматизации

**Риски использования западных SaaS:**

Американские компании обязаны соблюдать санкции. ElevenLabs, OpenAI, Anthropic и другие — все под этим давлением. В любой момент могут:
- Заблокировать по геолокации
- Отключить аккаунт
- Изменить условия

**Вывод для бизнеса:** Всегда иметь план Б. Резервный сервис или техническое решение для обхода.

---

## Диагностика

Первая мысль — проблема на нашей стороне.

Проверили:
- Сервер — работает ✓
- API — отвечает ✓
- Ключи — валидные ✓
- Логи — без ошибок ✓

Виджет падает при попытке установить голосовое соединение.

Копнули в документацию ElevenLabs:

> **ElevenLabs блокирует доступ из Беларуси.**

Не провайдер. Не государство. Сам сервис. Санкции США — компания юридически обязана блокировать пользователей из: Беларусь, Россия, Иран, Куба, КНДР, Сирия, Крым.

**Почему раньше работало?**

ElevenLabs периодически обновляет базы IP-адресов. Видимо, добавили новые диапазоны белорусских провайдеров. Вчера — ок, сегодня — блок.

---

## Для разработчиков: техническая часть

### Архитектура до поломки

```
┌─────────────┐      ┌─────────────┐      ┌─────────────────┐
│  Браузер    │ ──── │   Vercel    │ ──── │   ElevenLabs    │
│   (BY)      │      │    (US)     │      │      API        │
└─────────────┘      └─────────────┘      └─────────────────┘
       │                    │                      │
       │ 1. GET /api/signed-url ──────────────────►│
       │ 2. ◄──── signed_url (wss://...)───────────│
       │                                           │
       │ 3. WebSocket НАПРЯМУЮ ───────────────────►│
       │    IP = BY = BLOCKED ❌                    │
       └───────────────────────────────────────────┘
```

**Проблема:** Браузер устанавливает прямое WebSocket-соединение с ElevenLabs. Сервер ElevenLabs видит белорусский IP → отказ.

### Решение: WebSocket Proxy

```
┌─────────────┐      ┌─────────────┐      ┌─────────────────┐
│  Браузер    │ ──── │   Render    │ ──── │   ElevenLabs    │
│   (BY)      │      │  Proxy (US) │      │      API        │
└─────────────┘      └─────────────┘      └─────────────────┘
       │                    │                      │
       │  WebSocket ───────►│                      │
       │                    │  WebSocket ─────────►│
       │                    │  IP = US = OK ✓      │
       │◄══════════════════════════════════════════►│
       │         Аудио проксируется                │
```

### Ключевые моменты реализации

**1. Прокси на Node.js (~60 строк)**

```javascript
// Важно: сохранять тип сообщения (text vs binary)
clientWs.on('message', (data, isBinary) => {
  elevenLabsWs.send(data, { binary: isBinary });
});

elevenLabsWs.on('message', (data, isBinary) => {
  clientWs.send(data, { binary: isBinary });
});
```

**Критично:** ElevenLabs шлёт два типа сообщений:
- `text` — JSON команды
- `binary` — аудио данные

Если не передать флаг `isBinary` — клиент падает:
```
Uncaught SyntaxError: "[object Blob]" is not valid JSON
```

**2. Хостинг: Render (US регион)**

- Free план не подходит — обрывает WebSocket через 5 минут
- Starter план ($7/мес) — без лимитов на соединения

**3. Интеграция в API**

```typescript
// pages/api/elevenlabs/signed-url.ts
const wsProxyUrl = process.env.WS_PROXY_URL;

if (wsProxyUrl) {
  const proxiedUrl = `${wsProxyUrl}?url=${encodeURIComponent(data.signed_url)}`;
  return res.json({ signed_url: proxiedUrl, proxied: true });
}
```

**Репозиторий прокси:** Отдельный GitHub репо + автодеплой на Render.

---

## Для энтузиастов: как это работает под капотом

### Почему VPN помогает, а прокси на сервере — нет?

Многие думают: "У меня же сервер в US, почему блокирует?"

**Ответ:** API-запросы и WebSocket — разные вещи.

1. **API-запрос** `/api/signed-url` → идёт через ваш сервер → IP сервера (US) → OK
2. **WebSocket соединение** → устанавливается браузером напрямую → IP пользователя (BY) → BLOCK

ElevenLabs возвращает `signed_url` типа:
```
wss://api.elevenlabs.io/v1/convai/conversation?agent_id=xxx&signature=yyy
```

Браузер открывает этот URL напрямую. ElevenLabs видит откуда пришёл запрос.

### Почему нельзя просто nginx proxy?

WebSocket — это persistent connection с двусторонним обменом данными. Обычный HTTP reverse proxy не работает. Нужен именно WebSocket proxy, который:

1. Принимает WS-соединение от клиента
2. Открывает WS-соединение к целевому серверу
3. Передаёт сообщения в обе стороны
4. Корректно обрабатывает бинарные данные (аудио)
5. Поддерживает keepalive (ping/pong)

### Интересный баг при разработке

Первая версия прокси передавала все сообщения как бинарные. Результат:

```
JSON.parse("[object Blob]") → SyntaxError
```

ElevenLabs сначала шлёт JSON с конфигурацией, потом бинарный аудиопоток. Нужно определять тип каждого сообщения и передавать с правильным флагом.

---

## Результат

**Статус:** Виджет работает. Без VPN. Из Беларуси.

**Затраченное время:**
| Этап | Время |
|------|-------|
| Диагностика и исследование | 15 мин |
| Разработка прокси | 20 мин |
| Деплой и настройка | 15 мин |
| Отладка бинарных данных | 20 мин |
| **Итого** | **70 мин** |

**Дополнительные расходы:** +$7/месяц (Render Starter)

---

## Выводы

### Для бизнеса
- Западные SaaS могут отключить в любой момент — имейте план Б
- Стоимость простоя часто выше стоимости резервных решений
- Техническая поддержка должна реагировать быстро — 70 минут vs часы/дни

### Для разработчиков
- WebSocket !== HTTP — нужен специализированный прокси
- Binary vs Text — критично для аудио/видео приложений
- Serverless (Vercel) не поддерживает WebSocket — нужен отдельный сервис

### Для энтузиастов
- Санкции работают на уровне IP геолокации
- Прокси в правильном регионе решает большинство блокировок
- Понимание архитектуры помогает быстро находить решения

---

## Технический стек

- **Прокси:** Node.js + ws library
- **Хостинг прокси:** Render (Oregon, US)
- **Основной проект:** Next.js на Vercel
- **Голосовой AI:** ElevenLabs Conversational AI
- **Время разработки:** ~70 минут

---

*Столкнулись с похожей проблемой блокировок? Пишите — разберёмся и настроим обход.*

---

#кейс #devops #elevenlabs #санкции #websocket #proxy #ai #голосовойпомощник
